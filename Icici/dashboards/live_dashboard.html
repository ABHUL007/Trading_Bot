<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Dashboard - Enhanced Safe Trader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow-x: hidden;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-active { background: #00ff00; }
        .status-warning { background: #ffa500; }
        .status-error { background: #ff0000; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 8px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .metric-label {
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        .metric-negative {
            color: #ff4444;
        }
        
        .metric-warning {
            color: #ffaa00;
        }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .trades-table th,
        .trades-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .trades-table th {
            background: rgba(0, 212, 255, 0.2);
            font-weight: bold;
        }
        
        .trade-call { color: #00ff88; }
        .trade-put { color: #ff6b6b; }
        
        .breakout-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }
        
        .breakout-item {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .option-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .option-call { border-left-color: #00ff88; }
        .option-put { border-left-color: #ff6b6b; }
        
        .refresh-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .api-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .api-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #ffaa00, #ff4444);
            transition: width 0.3s ease;
        }
        
        .profit-loss {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .profit { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .loss { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        
        .loading {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ü§ñ Live Trading Dashboard</h1>
            <p><span class="status-indicator status-active"></span>Enhanced Safe Trader - Real-time Monitoring</p>
            <p>Last Updated: <span id="lastUpdate">Loading...</span></p>
        </div>

        <div class="refresh-info">
            <div>Auto-refresh: <span id="refreshTimer">10</span>s</div>
            <div>Status: <span id="refreshStatus">Active</span></div>
        </div>

        <div class="grid">
            <!-- Bot Status Card -->
            <div class="card">
                <h3>ü§ñ Bot Status</h3>
                <div class="metric">
                    <span class="metric-label">Trading Status:</span>
                    <span class="metric-value" id="botStatus">Loading...</span>
                </div>
                <div class="metric">
                    <span class="metric-label">API Usage:</span>
                    <span class="metric-value" id="apiUsage">0/95</span>
                </div>
                <div class="api-status">
                    <span>API Calls:</span>
                    <div class="api-bar">
                        <div class="api-fill" id="apiBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <span class="metric-label">Iteration:</span>
                    <span class="metric-value" id="iteration">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Action:</span>
                    <span class="metric-value" id="lastAction">Starting...</span>
                </div>
            </div>

            <!-- Market Data Card -->
            <div class="card">
                <h3>üìä Market Data</h3>
                <div class="metric">
                    <span class="metric-label">NIFTY:</span>
                    <span class="metric-value" id="niftyPrice">‚Çπ25,434</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Change:</span>
                    <span class="metric-value" id="niftyChange">-0.5%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">ATR 14:</span>
                    <span class="metric-value" id="atr">142.18</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Volatility:</span>
                    <span class="metric-value" id="volatility">Low</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Market Phase:</span>
                    <span class="metric-value" id="marketPhase">PHASE_3</span>
                </div>
            </div>

            <!-- P&L Card -->
            <div class="card">
                <h3>üí∞ P&L Summary</h3>
                <div class="profit-loss" id="totalPL">
                    <div>Total P&L: ‚Çπ0.00</div>
                </div>
                <div class="metric">
                    <span class="metric-label">Today's Trades:</span>
                    <span class="metric-value" id="todayTrades">1</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Positions:</span>
                    <span class="metric-value" id="activePositions">1</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Win Rate:</span>
                    <span class="metric-value" id="winRate">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Risk:</span>
                    <span class="metric-value" id="totalRisk">‚Çπ1,920</span>
                </div>
            </div>

            <!-- Breakouts Card -->
            <div class="card">
                <h3>üö® Live Breakouts</h3>
                <div class="breakout-list" id="breakoutsList">
                    <div class="loading">Loading breakout data...</div>
                </div>
            </div>
        </div>

        <!-- Recent Trades Table -->
        <div class="card">
            <h3>üìã Recent Trades</h3>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Strike</th>
                        <th>Price</th>
                        <th>Lots</th>
                        <th>P&L</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <tr>
                        <td>11:45:23</td>
                        <td class="trade-call">CALL</td>
                        <td>25400</td>
                        <td>‚Çπ124.90</td>
                        <td>16</td>
                        <td class="metric-value">‚Çπ+390</td>
                        <td>ACTIVE</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Live Options Data -->
        <div class="card">
            <h3>üìà Live Options Prices</h3>
            <div class="options-grid" id="optionsGrid">
                <div class="loading">Loading options data...</div>
            </div>
        </div>
    </div>

    <script>
        let refreshTimer = 10;
        let refreshInterval;

        // Auto-refresh functionality
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                refreshTimer--;
                document.getElementById('refreshTimer').textContent = refreshTimer;
                
                if (refreshTimer <= 0) {
                    refreshAllData();
                    refreshTimer = 10;
                }
            }, 1000);
        }

        // Refresh all dashboard data
        async function refreshAllData() {
            document.getElementById('refreshStatus').textContent = 'Updating...';
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            try {
                await Promise.all([
                    updateBotStatus(),
                    updateMarketData(),
                    updateBreakouts(),
                    updateTrades(),
                    updateOptions()
                ]);
                
                document.getElementById('refreshStatus').textContent = 'Active';
            } catch (error) {
                console.error('Refresh error:', error);
                document.getElementById('refreshStatus').textContent = 'Error';
            }
        }

        // Fetch real data from backend API
        async function updateBotStatus() {
            try {
                const response = await fetch('http://localhost:8000/api/bot-status');
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Bot status error:', data.error);
                    return updateBotStatusFallback();
                }
                
                document.getElementById('iteration').textContent = `#${data.iteration || 0}`;
                document.getElementById('botStatus').textContent = data.status || 'UNKNOWN';
                document.getElementById('apiUsage').textContent = data.api_usage || '0/95';
                document.getElementById('apiBar').style.width = `${data.api_percentage || 0}%`;
                document.getElementById('lastAction').textContent = data.last_action || 'Waiting...';
                
            } catch (error) {
                console.warn('Failed to fetch bot status, using fallback:', error);
                updateBotStatusFallback();
            }
        }
        
        function updateBotStatusFallback() {
            // Fallback simulation when backend is unavailable
            const iterations = [1, 5, 12, 18, 24, 30];
            const currentIteration = iterations[Math.floor(Math.random() * iterations.length)];
            
            document.getElementById('iteration').textContent = `#${currentIteration}`;
            document.getElementById('botStatus').textContent = 'ACTIVE';
            
            const apiUsage = Math.floor(Math.random() * 35) + 15;
            document.getElementById('apiUsage').textContent = `${apiUsage}/95`;
            document.getElementById('apiBar').style.width = `${(apiUsage/95)*100}%`;
            
            const actions = [
                'Collecting options data...',
                'Checking breakouts...',
                'Monitoring positions...',
                'Updating confluence...'
            ];
            document.getElementById('lastAction').textContent = actions[Math.floor(Math.random() * actions.length)];
        }

        async function updateMarketData() {
            try {
                const response = await fetch('http://localhost:8000/api/market-data');
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Market data error:', data.error);
                    return updateMarketDataFallback();
                }
                
                document.getElementById('niftyPrice').textContent = `‚Çπ${data.nifty_price.toFixed(2)}`;
                
                const changeElement = document.getElementById('niftyChange');
                changeElement.textContent = `${data.change_percent > 0 ? '+' : ''}${data.change_percent.toFixed(2)}%`;
                changeElement.className = data.change_percent >= 0 ? 'metric-value' : 'metric-negative';
                
            } catch (error) {
                console.warn('Failed to fetch market data, using fallback:', error);
                updateMarketDataFallback();
            }
        }
        
        function updateMarketDataFallback() {
            // Fallback simulation when backend is unavailable
            const basePrice = 25434;
            const variation = (Math.random() - 0.5) * 20;
            const currentPrice = basePrice + variation;
            
            document.getElementById('niftyPrice').textContent = `‚Çπ${currentPrice.toFixed(2)}`;
            
            const changePercent = ((variation / basePrice) * 100).toFixed(2);
            const changeElement = document.getElementById('niftyChange');
            changeElement.textContent = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
            changeElement.className = changePercent >= 0 ? 'metric-value' : 'metric-negative';
        }

        async function updateBreakouts() {
            try {
                const response = await fetch('http://localhost:8000/api/breakouts');
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Breakouts error:', data.error);
                    return updateBreakoutsFallback();
                }
                
                const breakoutsList = document.getElementById('breakoutsList');
                breakoutsList.innerHTML = data.breakouts.map(breakout => {
                    const status = breakout.status === 'BROKEN' ? 'üö®' : '‚ö†Ô∏è';
                    return `<div class="breakout-item">${status} ${breakout.type} (‚Çπ${breakout.level.toLocaleString()}) - ${breakout.probability}% prob</div>`;
                }).join('');
                
            } catch (error) {
                console.warn('Failed to fetch breakouts, using fallback:', error);
                updateBreakoutsFallback();
            }
        }
        
        function updateBreakoutsFallback() {
            const breakouts = [
                'Opening Range High (‚Çπ25,438) - 85% prob',
                'Previous Day Low (‚Çπ25,491) - 70% prob', 
                'EMA 50 approach (‚Çπ25,323) - 90% prob',
                '1 Week Low (‚Çπ25,491) - 70% prob'
            ];
            
            const breakoutsList = document.getElementById('breakoutsList');
            breakoutsList.innerHTML = breakouts.map(breakout => 
                `<div class="breakout-item">üö® ${breakout}</div>`
            ).join('');
        }

        async function updateTrades() {
            try {
                const response = await fetch('http://localhost:8000/api/trades');
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Trades error:', data.error);
                    return updateTradesFallback();
                }
                
                const plElement = document.getElementById('totalPL');
                plElement.innerHTML = `<div>Total P&L: ‚Çπ${data.total_pl >= 0 ? '+' : ''}${data.total_pl.toFixed(0)}</div>`;
                plElement.className = `profit-loss ${data.total_pl >= 0 ? 'profit' : 'loss'}`;
                
            } catch (error) {
                console.warn('Failed to fetch trades, using fallback:', error);
                updateTradesFallback();
            }
        }
        
        function updateTradesFallback() {
            const basePL = 390;
            const variation = (Math.random() - 0.5) * 200;
            const currentPL = basePL + variation;
            
            const plElement = document.getElementById('totalPL');
            plElement.innerHTML = `<div>Total P&L: ‚Çπ${currentPL >= 0 ? '+' : ''}${currentPL.toFixed(0)}</div>`;
            plElement.className = `profit-loss ${currentPL >= 0 ? 'profit' : 'loss'}`;
        }

        async function updateOptions() {
            try {
                const response = await fetch('http://localhost:8000/api/options');
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Options error:', data.error);
                    return updateOptionsFallback();
                }
                
                const optionsGrid = document.getElementById('optionsGrid');
                optionsGrid.innerHTML = data.options.map(opt => {
                    return `
                        <div class="option-card option-${opt.type.toLowerCase()}">
                            <div><strong>${opt.strike} ${opt.type}</strong></div>
                            <div>‚Çπ${opt.ltp.toFixed(2)}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">Vol: ${opt.volume || 'N/A'}</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.warn('Failed to fetch options, using fallback:', error);
                updateOptionsFallback();
            }
        }
        
        function updateOptionsFallback() {
            const options = [
                { strike: 25300, type: 'CALL', price: 175.25, volume: '83.2M' },
                { strike: 25300, type: 'PUT', price: 42.05, volume: '204.3M' },
                { strike: 25400, type: 'CALL', price: 124.90, volume: '260.1M' },
                { strike: 25400, type: 'PUT', price: 69.30, volume: '267.0M' },
                { strike: 25500, type: 'CALL', price: 73.15, volume: '202.7M' },
                { strike: 25500, type: 'PUT', price: 115.45, volume: '100.9M' }
            ];
            
            const optionsGrid = document.getElementById('optionsGrid');
            optionsGrid.innerHTML = options.map(opt => {
                const priceVar = (Math.random() - 0.5) * 2;
                const currentPrice = opt.price + priceVar;
                
                return `
                    <div class="option-card option-${opt.type.toLowerCase()}">
                        <div><strong>${opt.strike} ${opt.type}</strong></div>
                        <div>‚Çπ${currentPrice.toFixed(2)}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Vol: ${opt.volume}</div>
                    </div>
                `;
            }).join('');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllData();
            startAutoRefresh();
            
            // Add click to refresh manually
            document.querySelector('.header').addEventListener('click', function() {
                refreshTimer = 1; // Force refresh on next cycle
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' || e.key === 'R') {
                refreshAllData();
                refreshTimer = 10;
            }
            if (e.key === ' ') {
                e.preventDefault();
                refreshAllData();
            }
        });
    </script>
</body>
</html>