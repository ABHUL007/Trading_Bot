<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ LIVE NIFTY Trading Dashboard - ICICI Breeze</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }
        
        .live { background: #00ff00; color: #000; }
        .simulation { background: #ff9500; color: #000; }
        .disconnected { background: #ff0000; color: #fff; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .price-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .price-card:hover {
            transform: translateY(-5px);
        }
        
        .current-price {
            font-size: 3.5rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .price-change {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }
        
        .ml-insights {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ml-insights h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .insight-item:last-child {
            border-bottom: none;
        }
        
        .levels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .levels-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .levels-card h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .level-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .level-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .resistance-item {
            border-left: 4px solid #ff4444;
        }
        
        .support-item {
            border-left: 4px solid #00ff88;
        }
        
        .level-price {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .level-details {
            text-align: right;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .alerts-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        
        .alerts-section h3 {
            color: #FFD700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .alert-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ffaa00;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .timestamp {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
        }
        
        .strength-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .very-strong { background: #ff0000; color: white; }
        .strong { background: #ff9500; color: white; }
        .moderate { background: #ffaa00; color: black; }
        .weak { background: #888; color: white; }
        
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #00ff88 100%);
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .main-grid, .levels-grid {
                grid-template-columns: 1fr;
            }
            
            .current-price {
                font-size: 2.5rem;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¥ LIVE NIFTY Trading Dashboard</h1>
            <p>Real-time ICICI Breeze WebSocket with ML Analysis</p>
            <div id="connectionStatus" class="connection-status disconnected">
                üî¥ Connecting...
            </div>
        </div>

        <div class="main-grid">
            <div class="price-card">
                <div class="current-price" id="currentPrice">‚Çπ0.00</div>
                <div class="price-change" id="priceChange">+0.00 (0.00%)</div>
                <div id="trend">Trend: Sideways</div>
                <div id="momentum">Momentum: 0.00%</div>
            </div>

            <div class="ml-insights">
                <h3>ü§ñ ML Insights</h3>
                <div class="insight-item">
                    <span>Nearest Resistance:</span>
                    <span id="nearestResistance">‚Çπ-</span>
                </div>
                <div class="insight-item">
                    <span>Resistance Hit Probability:</span>
                    <span id="resistanceProb">-%</span>
                </div>
                <div class="insight-item">
                    <span>Nearest Support:</span>
                    <span id="nearestSupport">‚Çπ-</span>
                </div>
                <div class="insight-item">
                    <span>Support Hit Probability:</span>
                    <span id="supportProb">-%</span>
                </div>
                <div class="insight-item">
                    <span>Distance to Resistance:</span>
                    <span id="distanceResistance">- points</span>
                </div>
                <div class="insight-item">
                    <span>Distance to Support:</span>
                    <span id="distanceSupport">- points</span>
                </div>
            </div>
        </div>

        <div class="levels-grid">
            <div class="levels-card">
                <h3>üöÄ Resistance Levels</h3>
                <div id="resistanceLevels">
                    <!-- Dynamic resistance levels -->
                </div>
            </div>

            <div class="levels-card">
                <h3>üõ°Ô∏è Support Levels</h3>
                <div id="supportLevels">
                    <!-- Dynamic support levels -->
                </div>
            </div>
        </div>

        <div class="alerts-section">
            <h3>üö® Live Alerts</h3>
            <div id="alertsContainer">
                <div class="alert-item">
                    üì° Connecting to ICICI Breeze WebSocket...
                </div>
            </div>
        </div>

        <div class="timestamp" id="lastUpdate">
            Last Update: Connecting...
        </div>
    </div>

    <script>
        class NIFTYDashboard {
            constructor() {
                this.ws = null;
                this.previousPrice = 0;
                this.alerts = [];
                this.maxAlerts = 10;
                this.connect();
            }

            connect() {
                try {
                    this.ws = new WebSocket('ws://localhost:8766');
                    
                    this.ws.onopen = () => {
                        console.log('üîó Connected to NIFTY WebSocket');
                        this.updateConnectionStatus('connected', 'üü¢ Connected to WebSocket');
                        this.addAlert('‚úÖ Connected to NIFTY WebSocket server');
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (error) {
                            console.error('‚ùå Message parsing error:', error);
                        }
                    };

                    this.ws.onclose = () => {
                        console.log('üîå WebSocket connection closed');
                        this.updateConnectionStatus('disconnected', 'üî¥ Disconnected');
                        this.addAlert('‚ö†Ô∏è WebSocket connection lost - Reconnecting...');
                        setTimeout(() => this.connect(), 3000);
                    };

                    this.ws.onerror = (error) => {
                        console.error('‚ùå WebSocket error:', error);
                        this.updateConnectionStatus('disconnected', 'üî¥ Connection Error');
                        this.addAlert('‚ùå WebSocket connection error');
                    };

                } catch (error) {
                    console.error('‚ùå Connection error:', error);
                    this.updateConnectionStatus('disconnected', 'üî¥ Failed to Connect');
                    setTimeout(() => this.connect(), 5000);
                }
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'initial_data':
                    case 'price_update':
                        this.updatePrice(data);
                        this.updateLevels(data);
                        this.updateMLPredictions(data);
                        this.updateConnectionStatus(
                            data.live_feed ? 'live' : 'simulation',
                            data.live_feed ? 'üî¥ LIVE ICICI Feed' : 'üéÆ Simulation Mode'
                        );
                        break;
                    case 'pong':
                        console.log('üì° Pong received');
                        break;
                }
            }

            updatePrice(data) {
                const currentPrice = parseFloat(data.price);
                const change = currentPrice - this.previousPrice;
                const changePercent = this.previousPrice ? (change / this.previousPrice) * 100 : 0;

                // Update price display
                document.getElementById('currentPrice').textContent = `‚Çπ${currentPrice.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Update change display
                const changeElement = document.getElementById('priceChange');
                const changeText = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                changeElement.textContent = changeText;
                changeElement.className = 'price-change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral');

                // Check for significant moves
                if (Math.abs(change) > 10 && this.previousPrice > 0) {
                    const direction = change > 0 ? 'üöÄ UP' : 'üìâ DOWN';
                    this.addAlert(`${direction} Big Move: ‚Çπ${Math.abs(change).toFixed(2)} in NIFTY`);
                }

                this.previousPrice = currentPrice;
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = `Last Update: ${new Date(data.timestamp).toLocaleString()}`;
            }

            updateMLPredictions(data) {
                const predictions = data.ml_predictions || {};

                // Update trend and momentum
                document.getElementById('trend').textContent = `Trend: ${predictions.trend || 'Sideways'}`;
                document.getElementById('momentum').textContent = `Momentum: ${(predictions.momentum || 0).toFixed(2)}%`;

                // Update resistance info
                if (predictions.resistance_level) {
                    document.getElementById('nearestResistance').textContent = `‚Çπ${predictions.resistance_level.toFixed(2)}`;
                    document.getElementById('resistanceProb').textContent = `${(predictions.resistance_hit_probability * 100).toFixed(1)}%`;
                    document.getElementById('distanceResistance').textContent = `${predictions.distance_to_resistance.toFixed(2)} points`;
                } else {
                    document.getElementById('nearestResistance').textContent = '‚Çπ-';
                    document.getElementById('resistanceProb').textContent = '-%';
                    document.getElementById('distanceResistance').textContent = '- points';
                }

                // Update support info
                if (predictions.support_level) {
                    document.getElementById('nearestSupport').textContent = `‚Çπ${predictions.support_level.toFixed(2)}`;
                    document.getElementById('supportProb').textContent = `${(predictions.support_hit_probability * 100).toFixed(1)}%`;
                    document.getElementById('distanceSupport').textContent = `${predictions.distance_to_support.toFixed(2)} points`;
                } else {
                    document.getElementById('nearestSupport').textContent = '‚Çπ-';
                    document.getElementById('supportProb').textContent = '-%';
                    document.getElementById('distanceSupport').textContent = '- points';
                }
            }

            updateLevels(data) {
                // Update resistance levels
                const resistanceContainer = document.getElementById('resistanceLevels');
                resistanceContainer.innerHTML = '';
                
                if (data.resistance_levels && data.resistance_levels.length > 0) {
                    data.resistance_levels.forEach(level => {
                        const levelElement = this.createLevelElement(level, 'resistance');
                        resistanceContainer.appendChild(levelElement);
                    });
                }

                // Update support levels
                const supportContainer = document.getElementById('supportLevels');
                supportContainer.innerHTML = '';
                
                if (data.support_levels && data.support_levels.length > 0) {
                    data.support_levels.forEach(level => {
                        const levelElement = this.createLevelElement(level, 'support');
                        supportContainer.appendChild(levelElement);
                    });
                }
            }

            createLevelElement(level, type) {
                const div = document.createElement('div');
                div.className = `level-item ${type}-item`;
                
                const strengthClass = level.strength.toLowerCase().replace(' ', '-');
                const confidence = level.ml_confidence || 0;
                
                div.innerHTML = `
                    <div>
                        <div class="level-price">‚Çπ${level.level.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                        </div>
                    </div>
                    <div class="level-details">
                        <div class="strength-badge ${strengthClass}">${level.strength}</div>
                        <div>${level.timeframe} | ${(level.hit_probability * 100).toFixed(0)}%</div>
                        <div>Hits: ${level.hits || 0}</div>
                    </div>
                `;
                
                return div;
            }

            updateConnectionStatus(status, text) {
                const element = document.getElementById('connectionStatus');
                element.className = `connection-status ${status}`;
                element.textContent = text;
            }

            addAlert(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.alerts.unshift(`[${timestamp}] ${message}`);
                
                if (this.alerts.length > this.maxAlerts) {
                    this.alerts = this.alerts.slice(0, this.maxAlerts);
                }
                
                this.updateAlertsDisplay();
            }

            updateAlertsDisplay() {
                const container = document.getElementById('alertsContainer');
                container.innerHTML = '';
                
                this.alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = 'alert-item';
                    div.textContent = alert;
                    container.appendChild(div);
                });
            }

            // Send ping to keep connection alive
            sendPing() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({type: 'ping'}));
                }
            }
        }

        // Initialize dashboard
        const dashboard = new NIFTYDashboard();

        // Send ping every 30 seconds
        setInterval(() => {
            dashboard.sendPing();
        }, 30000);

        // Page visibility API to handle reconnection
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && (!dashboard.ws || dashboard.ws.readyState !== WebSocket.OPEN)) {
                dashboard.connect();
            }
        });
    </script>
</body>
</html>